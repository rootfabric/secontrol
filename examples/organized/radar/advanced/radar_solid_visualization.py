"""Визуализация solid из радара детектора руды с pyvista."""

from __future__ import annotations

import json
import sys
import threading
import time
from collections import defaultdict
from typing import Any, Dict, List, Optional, Sequence

import numpy as np
import pyvista as pv
from scipy.spatial.transform import Rotation

from secontrol.common import close, prepare_grid
from secontrol.devices.ore_detector_device import OreDetectorDevice
from secontrol.devices.ore_detector_device import OreDetectorDevice

def linear_to_3d(idx: int, sx: int, sy: int, sz: int) -> tuple[int, int, int]:
    """Преобразует линейный индекс в 3D координаты."""
    x = idx % sx
    y = (idx // sx) % sy
    z = idx // (sx * sy)
    return x, y, z


def extract_solid(radar: Dict[str, Any]) -> tuple[List[int], Dict[str, Any], List[Dict[str, Any]]]:
    """Извлекает solid массив, метаданные и contacts из радара."""
    raw = radar.get("raw", {})
    solid = raw.get("solid", [])
    if not isinstance(solid, list):
        solid = []

    metadata = {
        "size": raw.get("size", [100, 100, 100]),
        "cellSize": raw.get("cellSize", 1.0),
        "origin": raw.get("origin", [0.0, 0.0, 0.0]),
        "oreCellsTruncated": radar.get("oreCellsTruncated", 0),
        "rev": raw.get("rev", 0),
        "tsMs": raw.get("tsMs", 0),
    }

    contacts = radar.get("contacts", [])
    if not isinstance(contacts, list):
        contacts = []

    return solid, metadata, contacts


# ------------------------------------------------------------------
# Helpers for contact orientation
# ------------------------------------------------------------------

def _as_vector(value: Any) -> Optional[np.ndarray]:
    if not isinstance(value, Sequence):
        return None
    if len(value) != 3:
        return None
    try:
        nums = np.asarray(value, dtype=np.float64)
    except (TypeError, ValueError):
        return None
    return nums


def _get_vector_from_contact(contact: Dict[str, Any], *keys: str) -> Optional[np.ndarray]:
    for key in keys:
        value = contact.get(key)
        if value is None:
            continue
        vec = _as_vector(value)
        if vec is not None:
            return vec
    return None


def _extract_contact_matrix(contact: Dict[str, Any]) -> Optional[np.ndarray]:
    matrix_keys = ("matrix", "rotationMatrix", "orientationMatrix")
    for key in matrix_keys:
        matrix = contact.get(key)
        if matrix is None:
            continue
        arr = _as_vector(matrix)  # try 3 components first (should not match)
        if arr is not None:
            continue
        if isinstance(matrix, Sequence):
            if len(matrix) == 9:
                try:
                    flat = np.asarray(matrix, dtype=np.float64)
                except (TypeError, ValueError):
                    continue
                return flat.reshape(3, 3)
            if len(matrix) == 3 and all(isinstance(row, Sequence) and len(row) == 3 for row in matrix):
                try:
                    block = np.asarray(matrix, dtype=np.float64)
                except (TypeError, ValueError):
                    continue
                return block.reshape(3, 3)
    return None


def _normalize_vector(vec: np.ndarray) -> Optional[np.ndarray]:
    norm = np.linalg.norm(vec)
    if norm <= 1e-6:
        return None
    return vec / norm


def _contact_rotation_matrix(contact: Dict[str, Any]) -> Optional[np.ndarray]:
    mat = _extract_contact_matrix(contact)
    if mat is not None:
        return mat

    forward = _get_vector_from_contact(contact, "forward", "forwardVector", "direction")
    if forward is None:
        return None
    forward_norm = _normalize_vector(forward)
    if forward_norm is None:
        return None

    up = _get_vector_from_contact(contact, "up", "upVector", "normal")
    if up is None or np.linalg.norm(up) <= 1e-6:
        candidate = np.array([0.0, 1.0, 0.0], dtype=np.float64)
        if abs(np.dot(candidate, forward_norm)) > 0.99:
            candidate = np.array([1.0, 0.0, 0.0], dtype=np.float64)
        up_norm = candidate
    else:
        up_norm = _normalize_vector(up)
        if up_norm is None:
            up_norm = np.array([0.0, 1.0, 0.0], dtype=np.float64)

    right = np.cross(up_norm, forward_norm)
    right_norm = _normalize_vector(right)
    if right_norm is None:
        return None

    corrected_up = np.cross(forward_norm, right_norm)
    up_norm_final = _normalize_vector(corrected_up)
    if up_norm_final is None:
        return None

    return np.column_stack((right_norm, up_norm_final, forward_norm))


def _get_contact_position(contact: Dict[str, Any]) -> Optional[np.ndarray]:
    position = _get_vector_from_contact(contact, "position", "pos")
    if position is None:
        return None
    return position.astype(np.float64)


def _resolve_grid_orientation(
    contacts: Sequence[Dict[str, Any]],
    grid: Any | None,
) -> tuple[Optional[np.ndarray], Optional[np.ndarray]]:
    target_id: Optional[int] = None
    if grid is not None:
        grid_id = getattr(grid, "grid_id", None)
        try:
            if grid_id is not None:
                target_id = int(grid_id)
        except (TypeError, ValueError):
            target_id = None

    fallback: Optional[tuple[np.ndarray, np.ndarray]] = None
    for contact in contacts:
        contact_pos = _get_contact_position(contact)
        if contact_pos is None:
            continue
        rotation = _contact_rotation_matrix(contact)
        if rotation is None:
            continue
        contact_type = str(contact.get("type") or "").lower()
        contact_id = contact.get("id")
        parsed_id: Optional[int] = None
        try:
            if contact_id is not None:
                parsed_id = int(contact_id)
        except (TypeError, ValueError):
            parsed_id = None

        if target_id is not None and parsed_id == target_id:
            return rotation, contact_pos

        if fallback is None and contact_type == "grid":
            fallback = (rotation, contact_pos)

    return fallback or (None, None)


# Глобальные переменные для состояния
last_scan_state = {}
last_solid_data = None
cancel_requested = False

def input_thread():
    global cancel_requested
    while True:
        try:
            cmd = input("Введите 'c' для отмены сканирования: ").strip().lower()
            if cmd == 'c':
                cancel_requested = True
                print("Отмена запрошена...")
                break
        except EOFError:
            break

def visualize_solid(
    solid: List[int],
    metadata: Dict[str, Any],
    contacts: List[Dict[str, Any]],
    grid: Any | None = None,
) -> None:
    """Визуализирует solid как 3D облако точек с pyvista."""
    global last_solid_data
    if not solid:
        print("Нет данных solid для визуализации.")
        return

    # Проверка на изменение данных
    current_data = (solid[:10], metadata["rev"])  # Первые 10 индексов и rev
    if last_solid_data == current_data:
        return  # Данные не изменились
    last_solid_data = current_data

    size = metadata["size"]
    cellSize = metadata["cellSize"]
    origin = metadata["origin"]
    sx, sy, sz = size

    rotation_matrix, rotation_center = _resolve_grid_orientation(contacts, grid)

    points = []
    for idx in solid:
        x, y, z = linear_to_3d(idx, sx, sy, sz)
        wx = origin[0] + x * cellSize
        wy = origin[1] + y * cellSize
        wz = origin[2] + z * cellSize
        point = np.array([wx, wy, wz], dtype=np.float64)
        if rotation_matrix is not None and rotation_center is not None:
            point = rotation_matrix @ (point - rotation_center) + rotation_center
        points.append(tuple(point))

    print(points)
    # Создать PolyData из точек и voxelize
    cloud = pv.PolyData(points)
    print(cellSize)
    # voxels = pv.voxelize(cloud, density=cellSize)
    # print(voxels)

    # Добавить точки устройств
    grid_points = defaultdict(list)
    wheel_points = []
    for contact in contacts:
        pos = contact.get("position")
        if not pos:
            continue
        name = contact.get("name")
        if name == "Wheel":
            wheel_points.append(pos)
        else:
            entity_id = contact.get("entityId", "unknown")
            grid_points[entity_id].append(pos)


    # Использовать глобальный plotter для обновления
    global plotter
    if 'plotter' not in globals():
        plotter = pv.Plotter(off_screen=False)
        plotter.add_mesh(cloud, color='blue')
        colors = ['red', 'green', 'blue', 'yellow', 'purple', 'orange', 'cyan', 'magenta']
        for i, (eid, points) in enumerate(grid_points.items()):
            if points:
                color = colors[i % len(colors)]
                grid_cloud = pv.PolyData(points)
                plotter.add_mesh(grid_cloud, color=color)
        if wheel_points:
            wheel_cloud = pv.PolyData(wheel_points)
            plotter.add_mesh(wheel_cloud, color='black')
        plotter.add_text(f'Solid Visualization (rev={metadata["rev"]}, points={len(points)})', position='upper_left')
        plotter.show(auto_close=False, interactive=True)
    else:
        # Обновить поверхность
        plotter.clear()
        plotter.add_mesh(cloud, color='blue')
        colors = ['red', 'green', 'blue', 'yellow', 'purple', 'orange', 'cyan', 'magenta']
        for i, (eid, points) in enumerate(grid_points.items()):
            if points:
                color = colors[i % len(colors)]
                grid_cloud = pv.PolyData(points)
                plotter.add_mesh(grid_cloud, color=color)
        if wheel_points:
            wheel_cloud = pv.PolyData(wheel_points)
            plotter.add_mesh(wheel_cloud, color='black')
        plotter.add_text(f'Solid Visualization (rev={metadata["rev"]}, points={len(points)})', position='upper_left')
        plotter.render()

    # global plotter
    # if 'plotter' not in globals():
    #     plotter = pv.Plotter(off_screen=False)
    #     plotter.add_mesh(voxels, color='blue')
    #     plotter.add_text(f'Solid Visualization (rev={metadata["rev"]}, points={len(points)})', position='upper_left')
    #     plotter.show(auto_close=False, interactive=True)
    # else:
    #     # Обновить воксели
    #     plotter.clear()
    #     plotter.add_mesh(voxels, color='blue')
    #     plotter.add_text(f'Solid Visualization (rev={metadata["rev"]}, points={len(points)})', position='upper_left')
    #     plotter.render()
    #

def main() -> None:
    global cancel_requested
    # Запустить поток для ввода команд
    input_t = threading.Thread(target=input_thread, daemon=True)
    input_t.start()

    grid = prepare_grid("119052370536593617")
    try:
        # Найти ore_detector
        # detectors = grid.find_devices_by_type("ore_detector")
        detectors = grid.find_devices_by_type(OreDetectorDevice)
        if not detectors:
            print("На гриде не найдено ни одного детектора руды (ore_detector).")
            return
        device:OreDetectorDevice = detectors[0]
        print(f"Найден радар device_id={device.device_id} name={device.name!r}")
        print(f"Ключ телеметрии: {device.telemetry_key}")

        # Подписка на телеметрию
        def on_telemetry_update(dev: OreDetectorDevice, telemetry: Dict[str, Any], source_event: str) -> None:
            global last_scan_state
            if not isinstance(telemetry, dict):
                return

            # Сохранить состояние scan
            scan_state = telemetry.get("scan", {})
            if isinstance(scan_state, dict):
                last_scan_state = scan_state

            radar = telemetry.get("radar")
            if not isinstance(radar, dict):
                return

            solid, metadata, contacts = extract_solid(radar)
            print(f"Получен solid: {len(solid)} точек, rev={metadata['rev']}, truncated={metadata['oreCellsTruncated']}")
            print("Contacts:")
            print(json.dumps(contacts, indent=2))

            if solid:
                visualize_solid(solid, metadata, contacts, grid)

        device.on("telemetry", on_telemetry_update)

        # device.cancel_scan()

        # Отправить первое сканирование для solid
        print("Отправка команды scan для solid...")
        # while 1:
        seq = device.scan(
            include_players=False,
            include_grids=True,
            # budget_ms_per_tick=50,

            # полный скан
            # include_voxels=True,
            #   fullSolidScan = True,
            # voxel_step=10,
            # cell_size=3,
            # fast_scan=False,

            # Быстрый скан
            include_voxels=True,
            fullSolidScan = False,
            fast_scan=True,
            gridStep=10,



            radius = 50,

            boundingBoxX= 50,
            boundingBoxY= 50,
            boundingBoxZ= 50
            # fastScanTileEdgeMax=256



        )
        print(f"Scan отправлен, seq={seq}. Ожидание телеметрии... (Ctrl+C для выхода)")

        # Цикл отслеживания прогресса и ожидания
        last_progress = -1
        try:
            while True:
                # Проверка на отмену
                if cancel_requested:
                    print("Отправка команды отмены сканирования...")
                    device.cancel_scan()
                    cancel_requested = False  # Сбросить флаг

                # Печатать прогресс сканирования
                scan = last_scan_state
                if scan:
                    in_progress = scan.get("inProgress", False)
                    progress = scan.get("progressPercent", 0)
                    processed = scan.get("processedTiles", 0)
                    total = scan.get("totalTiles", 0)
                    elapsed = scan.get("elapsedSeconds", 0)

                    if in_progress and progress != last_progress:
                        print(f"[scan progress] {progress:.1f}% ({processed}/{total} tiles, {elapsed:.1f}s)")
                        last_progress = progress
                    elif not in_progress and last_progress != -1:
                        print(f"[scan] Завершено: {progress:.1f}% ({processed}/{total} tiles, {elapsed:.1f}s)")
                        last_progress = -1

                time.sleep(5)  # Пауза 1 сек
                device.update()

        except KeyboardInterrupt:
            print("Выход...")
        finally:
            device.off("telemetry", on_telemetry_update)
    finally:
        close(grid)


if __name__ == "__main__":
    main()


"""
C:\Python311\python.exe C:\secontrol\examples\organized\radar\advanced\radar_solid_visualization.py 
Введите 'c' для отмены сканирования: Resolved grid: 82580991479815662 (Respawn Rover)
Найден радар device_id=92075441454262520 name='Ore Detector'
Ключ телеметрии: se:144115188075855919:grid:82580991479815662:ore_detector:92075441454262520:telemetry
Отправка команды scan для solid...
{'cmd': 'scan', 'targetId': 92075441454262520, 'state': {'includePlayers': False, 'includeGrids': True, 'includeVoxels': True, 'radius': 50.0, 'budgetMsPerTick': 50.0, 'fast_scan': True, 'gridStep': 10.0}, 'targetName': 'Ore Detector'}
Scan отправлен, seq=2. Ожидание телеметрии... (Ctrl+C для выхода)
Получен solid: 410 точек, rev=33, truncated=0
[(1063456.4464285336, 158113.40619050368, 1675390.21148558), (1063444.4464285336, 158113.40619050368, 1675390.21148558), (1063447.4464285336, 158113.40619050368, 1675390.21148558), (1063435.4464285336, 158113.40619050368, 1675390.21148558), (1063426.4464285336, 158113.40619050368, 1675390.21148558), (1063444.4464285336, 158113.40619050368, 1675420.21148558), (1063468.4464285336, 158125.40619050368, 1675357.21148558), (1063477.4464285336, 158104.40619050368, 1675345.21148558), (1063468.4464285336, 158104.40619050368, 1675345.21148558), (1063435.4464285336, 158125.40619050368, 1675357.21148558), (1063426.4464285336, 158125.40619050368, 1675357.21148558), (1063435.4464285336, 158104.40619050368, 1675345.21148558), (1063456.4464285336, 158137.40619050368, 1675366.21148558), (1063456.4464285336, 158125.40619050368, 1675357.21148558), (1063426.4464285336, 158125.40619050368, 1675387.21148558), (1063447.4464285336, 158125.40619050368, 1675357.21148558), (1063444.4464285336, 158137.40619050368, 1675366.21148558), (1063447.4464285336, 158137.40619050368, 1675366.21148558), (1063444.4464285336, 158146.40619050368, 1675354.21148558), (1063444.4464285336, 158125.40619050368, 1675357.21148558), (1063456.4464285336, 158104.40619050368, 1675345.21148558), (1063435.4464285336, 158125.40619050368, 1675387.21148558), (1063447.4464285336, 158146.40619050368, 1675354.21148558), (1063444.4464285336, 158125.40619050368, 1675387.21148558), (1063435.4464285336, 158137.40619050368, 1675366.21148558), (1063444.4464285336, 158104.40619050368, 1675345.21148558), (1063447.4464285336, 158104.40619050368, 1675345.21148558), (1063447.4464285336, 158125.40619050368, 1675387.21148558), (1063468.4464285336, 158083.40619050368, 1675387.21148558), (1063456.4464285336, 158125.40619050368, 1675387.21148558), (1063426.4464285336, 158137.40619050368, 1675366.21148558), (1063477.4464285336, 158083.40619050368, 1675387.21148558), (1063447.4464285336, 158083.40619050368, 1675387.21148558), (1063444.4464285336, 158083.40619050368, 1675387.21148558), (1063435.4464285336, 158146.40619050368, 1675354.21148558), (1063456.4464285336, 158083.40619050368, 1675378.21148558), (1063447.4464285336, 158083.40619050368, 1675378.21148558), (1063426.4464285336, 158125.40619050368, 1675390.21148558), (1063456.4464285336, 158083.40619050368, 1675387.21148558), (1063444.4464285336, 158083.40619050368, 1675378.21148558), (1063435.4464285336, 158125.40619050368, 1675390.21148558), (1063477.4464285336, 158083.40619050368, 1675378.21148558), (1063468.4464285336, 158113.40619050368, 1675378.21148558), (1063444.4464285336, 158125.40619050368, 1675390.21148558), (1063447.4464285336, 158125.40619050368, 1675390.21148558), (1063435.4464285336, 158125.40619050368, 1675399.21148558), (1063456.4464285336, 158125.40619050368, 1675390.21148558), (1063468.4464285336, 158083.40619050368, 1675378.21148558), (1063426.4464285336, 158125.40619050368, 1675399.21148558), (1063447.4464285336, 158113.40619050368, 1675408.21148558), (1063444.4464285336, 158113.40619050368, 1675408.21148558), (1063444.4464285336, 158125.40619050368, 1675399.21148558), (1063447.4464285336, 158125.40619050368, 1675399.21148558), (1063426.4464285336, 158113.40619050368, 1675378.21148558), (1063435.4464285336, 158113.40619050368, 1675408.21148558), (1063435.4464285336, 158113.40619050368, 1675378.21148558), (1063444.4464285336, 158113.40619050368, 1675378.21148558), (1063447.4464285336, 158113.40619050368, 1675378.21148558), (1063444.4464285336, 158155.40619050368, 1675345.21148558), (1063456.4464285336, 158113.40619050368, 1675378.21148558), (1063447.4464285336, 158155.40619050368, 1675345.21148558), (1063468.4464285336, 158101.40619050368, 1675345.21148558), (1063456.4464285336, 158134.40619050368, 1675357.21148558), (1063480.4464285336, 158101.40619050368, 1675345.21148558), (1063447.4464285336, 158134.40619050368, 1675357.21148558), (1063477.4464285336, 158101.40619050368, 1675345.21148558), (1063444.4464285336, 158134.40619050368, 1675357.21148558), (1063447.4464285336, 158101.40619050368, 1675345.21148558), (1063435.4464285336, 158134.40619050368, 1675357.21148558), (1063444.4464285336, 158101.40619050368, 1675345.21148558), (1063426.4464285336, 158101.40619050368, 1675366.21148558), (1063456.4464285336, 158101.40619050368, 1675345.21148558), (1063426.4464285336, 158134.40619050368, 1675357.21148558), (1063435.4464285336, 158101.40619050368, 1675366.21148558), (1063444.4464285336, 158101.40619050368, 1675366.21148558), (1063447.4464285336, 158101.40619050368, 1675366.21148558), (1063435.4464285336, 158101.40619050368, 1675345.21148558), (1063456.4464285336, 158101.40619050368, 1675366.21148558), (1063468.4464285336, 158101.40619050368, 1675366.21148558), (1063477.4464285336, 158101.40619050368, 1675366.21148558), (1063444.4464285336, 158104.40619050368, 1675357.21148558), (1063447.4464285336, 158104.40619050368, 1675357.21148558), (1063456.4464285336, 158104.40619050368, 1675357.21148558), (1063426.4464285336, 158104.40619050368, 1675357.21148558), (1063444.4464285336, 158146.40619050368, 1675366.21148558), (1063435.4464285336, 158134.40619050368, 1675399.21148558), (1063435.4464285336, 158104.40619050368, 1675357.21148558), (1063447.4464285336, 158146.40619050368, 1675366.21148558), (1063426.4464285336, 158134.40619050368, 1675399.21148558), (1063435.4464285336, 158146.40619050368, 1675366.21148558), (1063426.4464285336, 158146.40619050368, 1675366.21148558), (1063468.4464285336, 158104.40619050368, 1675357.21148558), (1063477.4464285336, 158104.40619050368, 1675357.21148558), (1063435.4464285336, 158104.40619050368, 1675408.21148558), (1063444.4464285336, 158104.40619050368, 1675408.21148558), (1063447.4464285336, 158104.40619050368, 1675408.21148558), (1063456.4464285336, 158104.40619050368, 1675408.21148558), (1063435.4464285336, 158104.40619050368, 1675366.21148558), (1063426.4464285336, 158104.40619050368, 1675366.21148558), (1063480.4464285336, 158092.40619050368, 1675354.21148558), (1063456.4464285336, 158104.40619050368, 1675366.21148558), (1063477.4464285336, 158092.40619050368, 1675354.21148558), (1063435.4464285336, 158155.40619050368, 1675357.21148558), (1063426.4464285336, 158146.40619050368, 1675378.21148558), (1063447.4464285336, 158104.40619050368, 1675366.21148558), (1063468.4464285336, 158092.40619050368, 1675354.21148558), (1063444.4464285336, 158104.40619050368, 1675366.21148558), (1063435.4464285336, 158146.40619050368, 1675378.21148558), (1063444.4464285336, 158146.40619050368, 1675378.21148558), (1063477.4464285336, 158104.40619050368, 1675366.21148558), (1063447.4464285336, 158146.40619050368, 1675378.21148558), (1063444.4464285336, 158155.40619050368, 1675357.21148558), (1063468.4464285336, 158104.40619050368, 1675366.21148558), (1063447.4464285336, 158155.40619050368, 1675357.21148558), (1063435.4464285336, 158092.40619050368, 1675354.21148558), (1063456.4464285336, 158101.40619050368, 1675357.21148558), (1063447.4464285336, 158101.40619050368, 1675357.21148558), (1063444.4464285336, 158101.40619050368, 1675357.21148558), (1063456.4464285336, 158092.40619050368, 1675354.21148558), (1063444.4464285336, 158101.40619050368, 1675387.21148558), (1063435.4464285336, 158101.40619050368, 1675357.21148558), (1063447.4464285336, 158092.40619050368, 1675354.21148558), (1063444.4464285336, 158092.40619050368, 1675354.21148558), (1063447.4464285336, 158101.40619050368, 1675387.21148558), (1063426.4464285336, 158101.40619050368, 1675357.21148558), (1063456.4464285336, 158101.40619050368, 1675387.21148558), (1063447.4464285336, 158137.40619050368, 1675336.21148558), (1063444.4464285336, 158137.40619050368, 1675336.21148558), (1063426.4464285336, 158101.40619050368, 1675387.21148558), (1063456.4464285336, 158137.40619050368, 1675336.21148558), (1063435.4464285336, 158101.40619050368, 1675387.21148558), (1063456.4464285336, 158137.40619050368, 1675345.21148558), (1063477.4464285336, 158101.40619050368, 1675357.21148558), (1063447.4464285336, 158137.40619050368, 1675345.21148558), (1063444.4464285336, 158137.40619050368, 1675345.21148558), (1063468.4464285336, 158101.40619050368, 1675357.21148558), (1063435.4464285336, 158137.40619050368, 1675345.21148558), (1063468.4464285336, 158101.40619050368, 1675387.21148558), (1063447.4464285336, 158092.40619050368, 1675390.21148558), (1063444.4464285336, 158092.40619050368, 1675390.21148558), (1063456.4464285336, 158092.40619050368, 1675390.21148558), (1063444.4464285336, 158137.40619050368, 1675378.21148558), (1063447.4464285336, 158137.40619050368, 1675378.21148558), (1063435.4464285336, 158092.40619050368, 1675390.21148558), (1063477.4464285336, 158083.40619050368, 1675354.21148558), (1063480.4464285336, 158083.40619050368, 1675354.21148558), (1063426.4464285336, 158137.40619050368, 1675378.21148558), (1063468.4464285336, 158083.40619050368, 1675354.21148558), (1063435.4464285336, 158137.40619050368, 1675378.21148558), (1063456.4464285336, 158083.40619050368, 1675354.21148558), (1063447.4464285336, 158083.40619050368, 1675354.21148558), (1063468.4464285336, 158092.40619050368, 1675390.21148558), (1063444.4464285336, 158083.40619050368, 1675354.21148558), (1063477.4464285336, 158092.40619050368, 1675390.21148558), (1063435.4464285336, 158146.40619050368, 1675390.21148558), (1063426.4464285336, 158146.40619050368, 1675390.21148558), (1063447.4464285336, 158104.40619050368, 1675399.21148558), (1063444.4464285336, 158104.40619050368, 1675399.21148558), (1063456.4464285336, 158104.40619050368, 1675399.21148558), (1063426.4464285336, 158134.40619050368, 1675387.21148558), (1063435.4464285336, 158104.40619050368, 1675399.21148558), (1063435.4464285336, 158134.40619050368, 1675387.21148558), (1063444.4464285336, 158134.40619050368, 1675387.21148558), (1063447.4464285336, 158134.40619050368, 1675387.21148558), (1063468.4464285336, 158092.40619050368, 1675387.21148558), (1063477.4464285336, 158092.40619050368, 1675387.21148558), (1063447.4464285336, 158092.40619050368, 1675387.21148558), (1063444.4464285336, 158092.40619050368, 1675387.21148558), (1063456.4464285336, 158092.40619050368, 1675387.21148558), (1063435.4464285336, 158092.40619050368, 1675387.21148558), (1063426.4464285336, 158113.40619050368, 1675399.21148558), (1063435.4464285336, 158113.40619050368, 1675399.21148558), (1063444.4464285336, 158113.40619050368, 1675399.21148558), (1063447.4464285336, 158113.40619050368, 1675399.21148558), (1063456.4464285336, 158113.40619050368, 1675399.21148558), (1063447.4464285336, 158113.40619050368, 1675336.21148558), (1063444.4464285336, 158113.40619050368, 1675336.21148558), (1063456.4464285336, 158113.40619050368, 1675336.21148558), (1063456.4464285336, 158101.40619050368, 1675354.21148558), (1063468.4464285336, 158113.40619050368, 1675336.21148558), (1063444.4464285336, 158101.40619050368, 1675354.21148558), (1063447.4464285336, 158101.40619050368, 1675354.21148558), (1063435.4464285336, 158101.40619050368, 1675354.21148558), (1063426.4464285336, 158101.40619050368, 1675354.21148558), (1063477.4464285336, 158101.40619050368, 1675354.21148558), (1063480.4464285336, 158101.40619050368, 1675354.21148558), (1063444.4464285336, 158134.40619050368, 1675366.21148558), (1063468.4464285336, 158101.40619050368, 1675354.21148558), (1063447.4464285336, 158134.40619050368, 1675366.21148558), (1063456.4464285336, 158134.40619050368, 1675366.21148558), (1063435.4464285336, 158155.40619050368, 1675354.21148558), (1063426.4464285336, 158134.40619050368, 1675366.21148558), (1063435.4464285336, 158134.40619050368, 1675366.21148558), (1063447.4464285336, 158155.40619050368, 1675354.21148558), (1063444.4464285336, 158155.40619050368, 1675354.21148558), (1063444.4464285336, 158104.40619050368, 1675336.21148558), (1063447.4464285336, 158104.40619050368, 1675336.21148558), (1063456.4464285336, 158104.40619050368, 1675336.21148558), (1063456.4464285336, 158146.40619050368, 1675345.21148558), (1063447.4464285336, 158146.40619050368, 1675345.21148558), (1063435.4464285336, 158092.40619050368, 1675366.21148558), (1063444.4464285336, 158146.40619050368, 1675345.21148558), (1063435.4464285336, 158146.40619050368, 1675345.21148558), (1063447.4464285336, 158092.40619050368, 1675366.21148558), (1063468.4464285336, 158104.40619050368, 1675354.21148558), (1063426.4464285336, 158137.40619050368, 1675354.21148558), (1063444.4464285336, 158092.40619050368, 1675366.21148558), (1063435.4464285336, 158137.40619050368, 1675354.21148558), (1063456.4464285336, 158092.40619050368, 1675366.21148558), (1063477.4464285336, 158104.40619050368, 1675354.21148558), (1063444.4464285336, 158137.40619050368, 1675354.21148558), (1063468.4464285336, 158104.40619050368, 1675336.21148558), (1063447.4464285336, 158137.40619050368, 1675354.21148558), (1063468.4464285336, 158092.40619050368, 1675366.21148558), (1063456.4464285336, 158137.40619050368, 1675354.21148558), (1063477.4464285336, 158104.40619050368, 1675336.21148558), (1063447.4464285336, 158083.40619050368, 1675390.21148558), (1063477.4464285336, 158092.40619050368, 1675366.21148558), (1063426.4464285336, 158104.40619050368, 1675354.21148558), (1063444.4464285336, 158083.40619050368, 1675390.21148558), (1063477.4464285336, 158083.40619050368, 1675399.21148558), (1063447.4464285336, 158137.40619050368, 1675357.21148558), (1063468.4464285336, 158083.40619050368, 1675399.21148558), (1063456.4464285336, 158083.40619050368, 1675390.21148558), (1063435.4464285336, 158104.40619050368, 1675354.21148558), (1063444.4464285336, 158137.40619050368, 1675357.21148558), (1063456.4464285336, 158083.40619050368, 1675399.21148558), (1063456.4464285336, 158137.40619050368, 1675357.21148558), (1063447.4464285336, 158104.40619050368, 1675354.21148558), (1063444.4464285336, 158104.40619050368, 1675354.21148558), (1063444.4464285336, 158092.40619050368, 1675345.21148558), (1063426.4464285336, 158137.40619050368, 1675357.21148558), (1063447.4464285336, 158092.40619050368, 1675345.21148558), (1063456.4464285336, 158104.40619050368, 1675354.21148558), (1063456.4464285336, 158092.40619050368, 1675345.21148558), (1063435.4464285336, 158137.40619050368, 1675357.21148558), (1063468.4464285336, 158083.40619050368, 1675390.21148558), (1063477.4464285336, 158083.40619050368, 1675390.21148558), (1063435.4464285336, 158137.40619050368, 1675390.21148558), (1063468.4464285336, 158092.40619050368, 1675345.21148558), (1063477.4464285336, 158092.40619050368, 1675345.21148558), (1063480.4464285336, 158092.40619050368, 1675345.21148558), (1063426.4464285336, 158137.40619050368, 1675390.21148558), (1063444.4464285336, 158137.40619050368, 1675390.21148558), (1063447.4464285336, 158137.40619050368, 1675390.21148558), (1063444.4464285336, 158155.40619050368, 1675366.21148558), (1063426.4464285336, 158137.40619050368, 1675399.21148558), (1063456.4464285336, 158101.40619050368, 1675408.21148558), (1063447.4464285336, 158101.40619050368, 1675408.21148558), (1063444.4464285336, 158101.40619050368, 1675408.21148558), (1063435.4464285336, 158137.40619050368, 1675399.21148558), (1063435.4464285336, 158101.40619050368, 1675408.21148558), (1063435.4464285336, 158101.40619050368, 1675378.21148558), (1063435.4464285336, 158155.40619050368, 1675366.21148558), (1063426.4464285336, 158101.40619050368, 1675378.21148558), (1063456.4464285336, 158101.40619050368, 1675378.21148558), (1063468.4464285336, 158113.40619050368, 1675366.21148558), (1063444.4464285336, 158101.40619050368, 1675378.21148558), (1063447.4464285336, 158101.40619050368, 1675378.21148558), (1063468.4464285336, 158101.40619050368, 1675378.21148558), (1063435.4464285336, 158155.40619050368, 1675378.21148558), (1063435.4464285336, 158113.40619050368, 1675366.21148558), (1063426.4464285336, 158113.40619050368, 1675366.21148558), (1063456.4464285336, 158113.40619050368, 1675366.21148558), (1063435.4464285336, 158092.40619050368, 1675399.21148558), (1063435.4464285336, 158146.40619050368, 1675387.21148558), (1063444.4464285336, 158113.40619050368, 1675366.21148558), (1063435.4464285336, 158146.40619050368, 1675357.21148558), (1063447.4464285336, 158113.40619050368, 1675366.21148558), (1063447.4464285336, 158146.40619050368, 1675357.21148558), (1063426.4464285336, 158146.40619050368, 1675387.21148558), (1063444.4464285336, 158146.40619050368, 1675357.21148558), (1063456.4464285336, 158092.40619050368, 1675399.21148558), (1063447.4464285336, 158092.40619050368, 1675399.21148558), (1063468.4464285336, 158104.40619050368, 1675387.21148558), (1063444.4464285336, 158092.40619050368, 1675399.21148558), (1063468.4464285336, 158092.40619050368, 1675399.21148558), (1063435.4464285336, 158104.40619050368, 1675387.21148558), (1063426.4464285336, 158104.40619050368, 1675387.21148558), (1063447.4464285336, 158104.40619050368, 1675378.21148558), (1063456.4464285336, 158104.40619050368, 1675387.21148558), (1063444.4464285336, 158104.40619050368, 1675378.21148558), (1063447.4464285336, 158104.40619050368, 1675387.21148558), (1063444.4464285336, 158104.40619050368, 1675387.21148558), (1063456.4464285336, 158104.40619050368, 1675378.21148558), (1063456.4464285336, 158134.40619050368, 1675336.21148558), (1063426.4464285336, 158104.40619050368, 1675378.21148558), (1063447.4464285336, 158134.40619050368, 1675336.21148558), (1063444.4464285336, 158134.40619050368, 1675336.21148558), (1063435.4464285336, 158104.40619050368, 1675378.21148558), (1063456.4464285336, 158092.40619050368, 1675408.21148558), (1063468.4464285336, 158101.40619050368, 1675390.21148558), (1063444.4464285336, 158092.40619050368, 1675408.21148558), (1063447.4464285336, 158092.40619050368, 1675408.21148558), (1063468.4464285336, 158104.40619050368, 1675378.21148558), (1063444.4464285336, 158101.40619050368, 1675390.21148558), (1063447.4464285336, 158101.40619050368, 1675390.21148558), (1063456.4464285336, 158101.40619050368, 1675390.21148558), (1063435.4464285336, 158134.40619050368, 1675408.21148558), (1063435.4464285336, 158134.40619050368, 1675378.21148558), (1063426.4464285336, 158101.40619050368, 1675390.21148558), (1063426.4464285336, 158134.40619050368, 1675378.21148558), (1063435.4464285336, 158101.40619050368, 1675390.21148558), (1063444.4464285336, 158134.40619050368, 1675378.21148558), (1063447.4464285336, 158134.40619050368, 1675378.21148558), (1063444.4464285336, 158137.40619050368, 1675387.21148558), (1063468.4464285336, 158125.40619050368, 1675336.21148558), (1063447.4464285336, 158137.40619050368, 1675387.21148558), (1063426.4464285336, 158113.40619050368, 1675357.21148558), (1063456.4464285336, 158125.40619050368, 1675336.21148558), (1063447.4464285336, 158125.40619050368, 1675336.21148558), (1063435.4464285336, 158137.40619050368, 1675387.21148558), (1063435.4464285336, 158113.40619050368, 1675357.21148558), (1063444.4464285336, 158125.40619050368, 1675336.21148558), (1063426.4464285336, 158137.40619050368, 1675387.21148558), (1063447.4464285336, 158113.40619050368, 1675357.21148558), (1063468.4464285336, 158125.40619050368, 1675345.21148558), (1063444.4464285336, 158125.40619050368, 1675366.21148558), (1063444.4464285336, 158113.40619050368, 1675357.21148558), (1063447.4464285336, 158125.40619050368, 1675366.21148558), (1063456.4464285336, 158125.40619050368, 1675366.21148558), (1063456.4464285336, 158113.40619050368, 1675357.21148558), (1063456.4464285336, 158083.40619050368, 1675357.21148558), (1063468.4464285336, 158113.40619050368, 1675357.21148558), (1063426.4464285336, 158125.40619050368, 1675366.21148558), (1063444.4464285336, 158083.40619050368, 1675357.21148558), (1063435.4464285336, 158125.40619050368, 1675366.21148558), (1063447.4464285336, 158083.40619050368, 1675357.21148558), (1063468.4464285336, 158104.40619050368, 1675390.21148558), (1063435.4464285336, 158125.40619050368, 1675345.21148558), (1063456.4464285336, 158104.40619050368, 1675390.21148558), (1063447.4464285336, 158125.40619050368, 1675345.21148558), (1063444.4464285336, 158125.40619050368, 1675345.21148558), (1063447.4464285336, 158104.40619050368, 1675390.21148558), (1063444.4464285336, 158104.40619050368, 1675390.21148558), (1063456.4464285336, 158125.40619050368, 1675378.21148558), (1063456.4464285336, 158125.40619050368, 1675345.21148558), (1063435.4464285336, 158104.40619050368, 1675390.21148558), (1063444.4464285336, 158125.40619050368, 1675378.21148558), (1063426.4464285336, 158104.40619050368, 1675390.21148558), (1063447.4464285336, 158125.40619050368, 1675378.21148558), (1063477.4464285336, 158083.40619050368, 1675357.21148558), (1063435.4464285336, 158125.40619050368, 1675408.21148558), (1063468.4464285336, 158083.40619050368, 1675357.21148558), (1063435.4464285336, 158125.40619050368, 1675378.21148558), (1063447.4464285336, 158083.40619050368, 1675366.21148558), (1063426.4464285336, 158125.40619050368, 1675378.21148558), (1063444.4464285336, 158083.40619050368, 1675366.21148558), (1063456.4464285336, 158083.40619050368, 1675366.21148558), (1063444.4464285336, 158125.40619050368, 1675408.21148558), (1063468.4464285336, 158083.40619050368, 1675366.21148558), (1063477.4464285336, 158083.40619050368, 1675366.21148558), (1063435.4464285336, 158113.40619050368, 1675345.21148558), (1063456.4464285336, 158113.40619050368, 1675345.21148558), (1063477.4464285336, 158092.40619050368, 1675357.21148558), (1063447.4464285336, 158113.40619050368, 1675345.21148558), (1063444.4464285336, 158113.40619050368, 1675345.21148558), (1063468.4464285336, 158092.40619050368, 1675357.21148558), (1063468.4464285336, 158113.40619050368, 1675345.21148558), (1063435.4464285336, 158092.40619050368, 1675357.21148558), (1063456.4464285336, 158092.40619050368, 1675357.21148558), (1063444.4464285336, 158092.40619050368, 1675357.21148558), (1063447.4464285336, 158092.40619050368, 1675357.21148558), (1063477.4464285336, 158101.40619050368, 1675336.21148558), (1063480.4464285336, 158101.40619050368, 1675336.21148558), (1063468.4464285336, 158101.40619050368, 1675336.21148558), (1063435.4464285336, 158113.40619050368, 1675387.21148558), (1063456.4464285336, 158134.40619050368, 1675354.21148558), (1063426.4464285336, 158113.40619050368, 1675387.21148558), (1063456.4464285336, 158113.40619050368, 1675387.21148558), (1063444.4464285336, 158134.40619050368, 1675354.21148558), (1063444.4464285336, 158113.40619050368, 1675387.21148558), (1063447.4464285336, 158134.40619050368, 1675354.21148558), (1063447.4464285336, 158113.40619050368, 1675387.21148558), (1063435.4464285336, 158134.40619050368, 1675354.21148558), (1063456.4464285336, 158101.40619050368, 1675336.21148558), (1063447.4464285336, 158101.40619050368, 1675336.21148558), (1063426.4464285336, 158134.40619050368, 1675354.21148558), (1063444.4464285336, 158101.40619050368, 1675336.21148558), (1063456.4464285336, 158146.40619050368, 1675336.21148558), (1063426.4464285336, 158134.40619050368, 1675390.21148558), (1063435.4464285336, 158134.40619050368, 1675390.21148558), (1063444.4464285336, 158134.40619050368, 1675390.21148558), (1063468.4464285336, 158125.40619050368, 1675354.21148558), (1063447.4464285336, 158134.40619050368, 1675390.21148558), (1063435.4464285336, 158125.40619050368, 1675354.21148558), (1063426.4464285336, 158125.40619050368, 1675354.21148558), (1063456.4464285336, 158125.40619050368, 1675354.21148558), (1063444.4464285336, 158125.40619050368, 1675354.21148558), (1063435.4464285336, 158134.40619050368, 1675345.21148558), (1063447.4464285336, 158125.40619050368, 1675354.21148558), (1063447.4464285336, 158134.40619050368, 1675345.21148558), (1063444.4464285336, 158134.40619050368, 1675345.21148558), (1063456.4464285336, 158134.40619050368, 1675345.21148558), (1063456.4464285336, 158101.40619050368, 1675399.21148558), (1063444.4464285336, 158101.40619050368, 1675399.21148558), (1063447.4464285336, 158101.40619050368, 1675399.21148558), (1063435.4464285336, 158101.40619050368, 1675399.21148558), (1063468.4464285336, 158113.40619050368, 1675354.21148558), (1063444.4464285336, 158113.40619050368, 1675354.21148558), (1063447.4464285336, 158113.40619050368, 1675354.21148558), (1063456.4464285336, 158113.40619050368, 1675354.21148558), (1063426.4464285336, 158113.40619050368, 1675354.21148558), (1063435.4464285336, 158113.40619050368, 1675354.21148558), (1063477.4464285336, 158092.40619050368, 1675378.21148558), (1063468.4464285336, 158092.40619050368, 1675378.21148558), (1063456.4464285336, 158092.40619050368, 1675378.21148558), (1063447.4464285336, 158092.40619050368, 1675378.21148558), (1063444.4464285336, 158092.40619050368, 1675378.21148558), (1063435.4464285336, 158092.40619050368, 1675378.21148558)]
3.0
Получен solid: 410 точек, rev=33, truncated=0


"""
